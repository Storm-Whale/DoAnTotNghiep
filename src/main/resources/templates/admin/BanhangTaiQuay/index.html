<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ban Hang</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
    <link rel="stylesheet" th:href="@{/css/admin.css}">
    <link rel="stylesheet" th:href="@{/css/taiquay.css}">
    <!-- Thêm vào head hoặc trước khi đóng body -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<style>
    .alert {
        padding: 10px;
        margin-bottom: 15px;
        border: 1px solid transparent;
        border-radius: 4px;
    }

    .alert-warning {
        color: #856404;
        background-color: #fff3cd;
        border-color: #ffeeba;
    }

    .switch {
        position: relative;
        display: inline-block;
        width: 34px;
        height: 20px;
    }

    .switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        border-radius: 20px;
    }

    .slider:before {
        position: absolute;
        content: "";
        height: 14px;
        width: 14px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        border-radius: 50%;
        transition: 0.4s;
    }

    input:checked + .slider {
        background-color: #2196F3;
    }

    input:checked + .slider:before {
        transform: translateX(14px);
    }

    .diaChiCheck {
        margin-top: 20px;
    }

    #addressForm {
        display: flex;
        flex-wrap: wrap; /* Đảm bảo form phản hồi tốt trên các màn hình nhỏ */
        align-items: center; /* Căn giữa theo chiều dọc */
        gap: 10px; /* Khoảng cách giữa các phần tử */
    }

    #addressForm label {
        font-size: 14px;
        color: #333;
        margin-right: 10px;
    }

    #addressForm input[type="text"] {
        padding: 8px 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        flex: 1; /* Cho phép input giãn nở */
        min-width: 200px; /* Đảm bảo kích thước tối thiểu */
        font-size: 14px;
    }

    #addressForm button {
        padding: 8px 15px;
        background-color: #007bff;
        color: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.3s;
    }

    #addressForm button:hover {
        background-color: #0056b3;
    }

</style>
<body class="container-fluid">
<article th:replace="~{admin/fragments/article :: article}"></article>
<header th:replace="~{admin/fragments/header :: header}"></header>
<nav th:replace="~{admin/fragments/nav :: nav}"></nav>

<section class="page-content my-4">
    <h4 style="margin-left: 30px; margin-top: 10px; margin-bottom: 30px"><b>Bán hàng tại quầy</b></h4>
<!--    <h5>Tên nhân viên: <span th:text="${nhanvien.ten}">Tên nhân viên</span></h5>-->
    <form id="createInvoiceForm">
        <button id="btnCreateInvoice" style="background-color: #ff6b6b; border-radius: 20px; border: 1px solid #ccc;"
                type="button"><i class="bi bi-align-center">Tạo Hóa Đơn</i></button>
    </form>
    <div class="container">

        <div id="invoiceList" style="margin-top: 20px;">
            <ul style="list-style-type: none; padding: 0; display: flex; flex-wrap: wrap;">
                <li class="invoice-item" th:each="hoaDon : ${listHD}" th:attr="data-id=${hoaDon.id}"
                    style="margin-right: 15px;">
                    <a th:href="@{/admin/taiquay/detail/{id}(id=${hoaDon.id})}"
                       th:text="'Hóa đơn ' + ${hoaDon.id}" style="text-decoration: none;" class="invoice-link"
                       th:attr="data-id=${hoaDon.id}"
                    ></a>
                    <span class="invoice-close-btn">&times;</span>
                </li>
            </ul>
        </div>
        <!--        //-->
        <div class="section">
            <div>
                <div class="d-flex justify-content-between">
                    <div>
                        <button class="btn btn-dark" onclick="toggleCamera()">Quét QR</button>
                        <div style="margin-bottom: 20px; margin-top: 20px">
                            <video id="qr-video" width="240" height="160" style="display: none;"></video>
                            <canvas id="qr-canvas" width="400" height="300" style="display:none;"></canvas>
                        </div>
                    </div>
                </div>

                <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

                <a class="taiquay">
                    <a href="#" onclick="checkAddProduct(); return false;" th:href="@{/admin/taiquay/sanpham#sanpham}">
                    <button class="btn btn-light">Thêm Sản Phẩm</button>
                    </a>
                </a>
            </div>
            <div class="container-row">
                <div class="custom-table">
                    <div class="custom-table1">
                        <table class="table table-bordered table-hover text-center ">
                            <thead class="table-light">
                            <tr>
                                <th scope="col">STT</th>
                                <th scope="col">Sản Phẩm</th>
                                <th scope="col">SL</th>
                                <th scope="col">Đơn Giá</th>
                                <th scope="col">Tổng</th>
                                <th scope="col">Thao Tác</th>
                            </tr>
                            </thead>
                            <tbody id="cartTable1">
                            <tr th:each="hdct,stt : ${listHDCT}">
                                <td th:text="${stt.index + 1}"></td>
                                <td th:text="${hdct.sanPhamChiTiet.sanPham.tenSanPham}"></td>
                                <td>
                                    <button class="btn btn-sm btn-light"
                                            style="margin-right: 3px; background-color: #ffecee"
                                            th:attr="onclick='updateQuantity(' + ${hdct.id} + ', -1)'">-
                                    </button>
                                    <input type="number"
                                           class="quantity-input"
                                           th:id="'quantity-' + ${hdct.id}"
                                           th:value="${hdct.soLuong}"
                                           min="1"
                                           style="width: 30px; text-align: center; background-color: #ffecee" ;
                                           th:data-current-quantity="${hdct.soLuong}"
                                           th:data-stock-quantity="${hdct.sanPhamChiTiet.soLuong}"
                                           th:onchange="'updateQuantityDirectly(this, ' + ${hdct.id} + ')'">
                                    <button class="btn btn-sm btn-light"
                                            style="margin-left: 3px; background-color: #ffecee"
                                            th:attr="onclick='updateQuantity(' + ${hdct.id} + ', 1)'">+
                                    </button>
                                </td>
                                <td th:text="${#numbers.formatDecimal(hdct.sanPhamChiTiet.gia, 1, 'COMMA', 0, 'POINT')} + 'đ'"></td>
                                <td th:text="${#numbers.formatDecimal(hdct.sanPhamChiTiet.gia.multiply(hdct.soLuong),1, 'COMMA', 0, 'POINT')}+ 'đ'"></td>
                                <td><a th:href="@{/admin/taiquay/xoa-sanpham-hdct/{id}(id=${hdct.id})}"
                                       class="btn btn-light" title="Xóa"><i class="bi bi-trash-fill fs-5"></i></a></td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="custom-note-row">
                        <span class="note">Tổng tiền đơn hàng : </span>
                        <span class="total"
                              th:text="${#numbers.formatDecimal(tongTien, 1, 'COMMA', 0, 'POINT')}"></span> vnđ
                    </div>
<style>
    .diaChiCheck {
        background-color: #f9f9f9; /* Màu nền nhẹ */
        border: 1px solid #ddd; /* Đường viền nhẹ */
        border-radius: 8px; /* Bo góc */
        padding: 20px; /* Khoảng cách bên trong */
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); /* Đổ bóng nhẹ */
        /*max-width: 400px; !* Chiều rộng tối đa *!*/
        margin: 20px auto; /* Căn giữa */
        float: left;
    }

    .address-label {
        font-size: 16px; /* Kích thước chữ */
        font-weight: bold; /* Chữ đậm */
        margin-bottom: 10px; /* Khoảng cách dưới label */
        display: block; /* Hiển thị dưới dạng khối */
    }

    .input-group {
        display: flex; /* Sử dụng flexbox */
        align-items: center; /* Căn giữa theo chiều dọc */
        margin-bottom: 15px; /* Khoảng cách dưới input group */
    }

    .input-field {
        flex: 1; /* Chiếm toàn bộ không gian còn lại */
        padding: 10px; /* Khoảng cách bên trong */
        border: 1px solid #ccc; /* Đường viền */
        border-radius: 4px; /* Bo góc */
        font-size: 14px; /* Kích thước chữ */
        transition: border-color 0.3s; /* Hiệu ứng chuyển tiếp */
    }

    .input-field:focus {
        border-color: #007bff; /* Đổi màu viền khi focus */
        outline: none; /* Ẩn outline mặc định */
    }

    .update-button {
        background-color: #007bff; /* Màu nền nút */
        color: white; /* Màu chữ */
        border: none; /* Không có đường viền */
        border-radius: 4px; /* Bo góc */
        padding: 10px 15px; /* Khoảng cách bên trong */
        cursor: pointer; /* Con trỏ chuột */
        transition: background-color 0.3s; /* Hiệu ứng chuyển tiếp */
    }

    .update-button:hover {
        background-color: #0056b3; /* Đổi màu khi hover */
    }

    .note-section {
        display: flex; /* Sử dụng flexbox */
        align-items: center; /* Căn giữa theo chiều dọc */
    }

    .note-label {
        font-size: 14px; /* Kích thước chữ */
        margin-right: 10px; /* Khoảng cách bên phải */
    }

    .note-input {
        flex: 1; /* Chiếm toàn bộ không gian còn lại */
        padding: 10px; /* Khoảng cách bên trong */
        border: 1px solid #ccc; /* Đường viền */
        border-radius: 4px; /* Bo góc */
        font-size: 14px; /* Kích thước chữ */
        transition: border-color 0.3s; /* Hiệu ứng chuyển tiếp */
    }

    .note-input:focus {
        border-color: #007bff; /* Đổi màu viền khi focus */
        outline: none; /* Ẩn outline mặc định */
    }

</style>
                    <div class="diaChiCheck">
                        <form id="addressForm" style="display: none;" th:action="@{/admin/taiquay/cap-nhat-hoa-don}" method="post">
                            <input type="hidden" name="idHoaDon" th:value="${hoaDon.id}" />

                            <label for="diaChi">Địa chỉ:</label>
                            <input type="text" id="diaChi" name="diaChi" th:value="${hoaDon.diaChi != null ? hoaDon.diaChi.diaChiChiTiet : ''}" />

                            <label for="soDienThoai1">Số điện thoại:</label>
                            <input type="text" id="soDienThoai1" name="soDienThoai"
                                   th:value="${hoaDon.diaChi != null ? hoaDon.diaChi.soDienThoai : ''}" />

                            <label for="tenNguoiNhan">Tên người nhận:</label>
                            <input type="text" id="tenNguoiNhan" name="tenNguoiNhan" th:value="${hoaDon.diaChi != null ? hoaDon.diaChi.tenKhachHang : ''}" />

                            <label for="ghiChu">Ghi chú:</label>
                            <input type="text" id="ghiChu" name="ghiChu" th:value="${hoaDon.ghiChu}">

                            <button type="submit">Cập nhật</button>
                        </form>
                    </div>
                </div>
                <div class="payment-info">
                    <p style="margin-top: 7px;margin-bottom: 7px;"><b><i class="bi bi-diamond-fill fs3">Thông tin thanh
                        toán</i></b></p>

                    <div style="display: flex; align-items: center; gap: 20px;">
                        <form th:action="@{/admin/taiquay/tim-kiem}" method="get"
                              style="display: flex; align-items: center; gap: 10px;">
                            <input type="text" id="soDienThoai" name="soDienThoai" required
                                   style="padding: 5px; border-radius: 5px; border: 1px solid #ddd; width: 200px;">
                            <button type="submit"
                                    style="background-color: #2c3e50; color: white;margin-bottom: 5px; padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer;">
                                Tìm kiếm KH
                            </button>

                        </form>

                        <style>
                            .error-message {
                                height: 30px;
                                color: red;
                                margin-top: 5px; /* Khoảng cách từ button đến thông báo lỗi */
                                font-weight: bold; /* Đậm chữ thông báo lỗi */
                            }
                        </style>
                        <div>
                            <label class="switch">
                                <input type="checkbox" id="toggleAddress"/>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div id="themnhanhkhachhang" class="dialogmodal">
                        <div class="modal__center">
                            <div class="thongBao">
                            <p>Hiện không có số điện thoại này! Bạn có muốn thêm mới không?</p>
                            <a href="/admin/taiquay/themnhanhkhachhang"><button>Có</button></a>
                            <a href=""><button>Không</button></a>
                            <a href="#" class="modal__close">&times;</a>
                            </div>
                        </div>
                        </div>
                    </div>
                    <div class="error-message" th:if="${errorMessage}" style="color: red;">
                        <p th:text="${errorMessage}"></p>
                    </div>
                    <div class="half">
                        <!-- Tên Khách Hàng -->
                        <div style="display: flex; align-items: center; margin-bottom: 5px; width: 300px;">
                            <span style="font-size: 14px; margin-top: 10px;">Tên Khách Hàng:</span>
                            <span th:text="${khachHang != null ? khachHang.ten : 'Khách lẻ'}"
                                  style="font-size: 14px;margin-top: 10px; color: #2c3e50; background-color: #f0f0f0; padding: 5px 10px; border-radius: 5px; margin-left: 10px;"></span>
                        </div>
                        <!-- Số Điện Thoại -->
                        <div style="display: flex; align-items: center;width: 300px;">
                            <span style="font-size: 14px; margin-top: 10px;">Số điện thoại:</span>
                            <span th:text="${khachHang != null ? khachHang.soDienThoai : ''}"
                                  style="font-size: 14px; margin-top: 10px; color: #2c3e50; background-color: #f0f0f0; padding: 5px 10px; border-radius: 5px; margin-left: 10px;"></span>
                        </div>
                    </div>

                    <div style="display: flex; align-items: center; gap: 20px;">
                        <form id="formGiamGia" th:action="@{/admin/taiquay/kiemtrama}" method="post"
                              class="discount-form">
                            <span style="font-size: 14px; margin-top: 10px;">Phiếu giảm giá </span>
                            <input type="text" id="maPhieuGiamGia"
                                   name="maPhieuGiamGia"
                                   th:value="${maPhieuGiamGia}" readonly/>
                        </form>
                    </div>

                    <p style="font-size: 14px; margin-top: 10px;">Tiền Tạm Tính:
                        <span id="subtotal"
                              th:text="${#numbers.formatDecimal((tongTien != null ? tongTien : 0), 1, 'COMMA', 0, 'POINT')} + ' đ'">0</span>
                    </p>
                    <p style="font-size: 14px;">
                        Số Tiền Giảm Giá:
                        <span id="discount"
                              th:text="${(tongTien != null && tongTienSauGiam != null && tongTienSauGiam < tongTien)
                    ? #numbers.formatDecimal(tongTien - tongTienSauGiam, 1, 'COMMA', 0, 'POINT') + ' đ'
                    : '0 đ'}">0 đ</span>
                    </p>
                    <div th:if="${error}">
                        <p style="color: red;" th:text="${error}"></p>
                    </div>

                    <form action="/admin/taiquay/thanhtoan" method="get" id="paymentForm" target="pdfWindow"
                          class="thanhtoan">
                        <div >
                            <label style="font-size: 14px;margin-top: 10px;">Khách cần
                                trả:</label>
                            <b><span id="tongTien" style="font-size: 14px;"
                                     th:text="${tongTienSauGiam == null || tongTienSauGiam == 0  ? #numbers.formatDecimal(tongTien, 1, 'COMMA', 0, 'POINT') + ' đ' : #numbers.formatDecimal(tongTienSauGiam, 1, 'COMMA', 0, 'POINT')} + ' đ'">0 đ</span></b>
                            <input type="hidden" name="tongTien"
                                   th:value="${#numbers.formatDecimal((tongTienSauGiam == null ? tongTien : (tongTien != null ? tongTien : 0)), 1, 'COMMA', 0, 'POINT') + ' đ'}"/>
                        </div>

                        <div class="received">
                            <script src="https://cdnjs.cloudflare.com/ajax/libs/big.js/6.0.3/big.min.js"></script>
                            <label>Số tiền khách đưa:</label>
                            <input type="number" id="soTienKhachDua" name="soTienKhachDua"
                                   style="width: 200px;height: 20px" step="0.01"
                                   oninput="tinhTienThua()"/>
                        </div>
                        <div class="change">
                            <label>Tiền thừa:</label>
                            <span id="tienThua">0</span>
                        </div>

                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label style="font-size: 13px; margin-right: 10px;margin-top: 10px;">Phương
                                thức:</label>

                            <div class="form-check" style="display: flex; align-items: center;">
                                <input class="form-check-input" style="margin-bottom: 5px;margin-top: 10px;"
                                       type="radio" name="phuongThucThanhToan" value="1" checked>
                                <label class="form-check-label"
                                       style="margin-right: 15px; margin-left: 5px;margin-top: 10px;font-size: 12px;">Tiền
                                    Mặt</label>
                            </div>

                            <div class="form-check" style="display: flex; align-items: center;">
                                <input class="form-check-input" type="radio"
                                       style="margin-bottom: 5px;margin-top: 10px;" name="phuongThucThanhToan"
                                       value="3">
                                <label class="form-check-label"
                                       style="margin-right: 15px;margin-left: 5px;margin-top: 10px;font-size: 12px;">Chuyển
                                    Khoản</label>
                            </div>
                        </div>
                        <input type="hidden" id="khachHangId" name="khachHangId" th:value="${khachHang != null ? khachHang.ten : ''}"> <!-- Đảm bảo value được cập nhật -->
                        <input type="hidden" name="maPhieuGiamGia" th:value="${maPhieuGiamGia}">
                        <button id="btnCheckout" type="button" style="margin-top: 10px;background-color: #2c3e50;">
                            Xác nhận
                        </button>
                        <a href="#" class="modal__close">&times;</a>
                    </form>
                    <!-- Modal HTML -->
                    <div id="customerModal" class="modal" style="display:none;">
                        <div class="modal-content">
                            <span class="close" onclick="closeModal()">&times;</span>
                            <p>Chưa có khách hàng. Bạn có muốn thêm không?</p>
                            <button onclick="redirectToAddCustomer()">Có</button>
                            <button onclick="closeModal()">Không</button>
                        </div>
                    </div>

                    <script>
                        function showModal() {
                            document.getElementById('customerModal').style.display = 'block';
                        }
                        function closeModal() {
                            document.getElementById('customerModal').style.display = 'none';
                        }
                        function redirectToAddCustomer() {
                            window.location.href = "/admin/taiquay/add"; // Đường dẫn đến trang thêm khách hàng
                        }
                        // Hàm này sẽ được gọi khi nhận được phản hồi từ server
                        function handlePaymentResponse(response) {
                            if (response.includes("Chưa có khách hàng")) {
                                showModal();
                            } else {
                                // Xử lý thanh toán thành công hoặc các phản hồi khác
                            }
                        }
                    </script>
                    <script>
                        function confirmPayment() {
                            // Gửi yêu cầu thanh toán
                            fetch('/thanhtoan', {
                                method: 'GET',
                                // Các tham số cần thiết khác
                            })
                                .then(response => response.text())
                                .then(data => handlePaymentResponse(data))
                                .catch(error => console.error('Error:', error));
                        }
                    </script>
                </div>
            </div>
        </div>
    </div>
    </script>
    <!-- ComboBox Lọc Kích Cỡ -->
    <div id="sanpham" class="dialogmodal">
        <div class="modal__center">
            <h4>Sản phẩm</h4>
            <div th:replace="~{admin/BanhangTaiQuay/SPCTTable :: form}"></div>
            <!-- Table Sản phẩm -->
            <div th:replace="~{admin/BanhangTaiQuay/SPCTTable :: table}"></div>
            <!--            <a th:href="@{/admin/taiquay/detail/{id}(id=${idHoaDon})}" class="modal__close">&times;</a>-->
            <a th:href="@{${idHoaDon != null ? '/admin/taiquay/detail/' + idHoaDon : '/admin/taiquay'}}"
               class="modal__close">&times;</a>

            <div style="margin-top: 15px" class="d-flex align-items-center">
                <label for="itemsPerPage2" class="me-2">Xem</label>
                <select class="form-select form-select-sm" id="itemsPerPage2" name="size"
                        onchange="changeItemsPerPage2()" style="width: 80px;">
                    <option value="5" th:selected="${size == 5}">5</option>
                    <option value="10" th:selected="${size == 10}">10</option>
                    <option value="15" th:selected="${size == 15}">15</option>
                    <option value="20" th:selected="${size == 20}">20</option>
                </select>
            </div>
            <div th:replace="~{admin/BanhangTaiQuay/SPCTTable :: nav}"></div>
            <div th:replace="~{admin/BanhangTaiQuay/SPCTTable :: script}"></div>
        </div>
    </div>
</section>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</section>
</body>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/javascript/admin.js}"></script>
<script th:src="@{/javascript/thanhtoan.js}"></script>
<script th:src="@{/javascript/taiquay.js}"></script>
<script>
    // Gán giá trị idHoaDon từ server qua Thymeleaf
    let idHoaDon = [[${idHoaDon}]];
    console.log("idHoaDon: " + idHoaDon);
    // Khởi tạo các biến cần thiết cho camera
    const video = document.getElementById('qr-video');
    const canvas = document.getElementById('qr-canvas');
    const context = canvas.getContext('2d');
    let isCameraOn = false;

    // Hàm toggle camera khi nhấn nút Quét QR
    function toggleCamera() {
        const currentUrl = window.location.href;
        if (currentUrl === "http://localhost:8080/admin/taiquay") {
            Swal.fire({
                icon: 'warning',
                title: 'Chọn hóa đơn trước',
                text: 'Vui lòng chọn hóa đơn trước khi quét QR.',
                confirmButtonText: 'OK'
            });
            return; // Không cho phép quét QR
        }
        // Thực hiện mở/tắt camera
        if (isCameraOn) {
            // Tắt camera
            video.style.display = "none";
            canvas.style.display = "none";
            isCameraOn = false;
            console.log("Camera closed");
        } else {
            // Bật camera
            startCamera();
            isCameraOn = true;
            console.log("Camera opened");
        }
    }
    // Hàm khởi động camera
    function startCamera() {
        navigator.mediaDevices.getUserMedia({video: {facingMode: 'environment'}})
            .then(stream => {
                video.srcObject = stream;
                video.play();
                video.onloadedmetadata = () => {
                    console.log("Video metadata loaded");
                    requestAnimationFrame(tick);
                };
            })
            .catch(error => {
                console.error('Unable to access the camera/webcam.', error);
                alert("Không thể truy cập camera.");
            });

        video.style.display = 'block';
        canvas.style.display = 'none';
    }
    // get qr scan to controller
    async function tick() {
        console.log("Video dimensions:", video.videoWidth, video.videoHeight);
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            console.log("Tick function is running...");
            canvas.height = video.videoHeight;
            canvas.width = video.videoWidth;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);

            if (code) {
                const qrData = code.data;
                console.log("Dữ liệu mã QR: ", qrData);
                const decodedData = decodeURIComponent(escape(qrData));
                console.log("Dữ liệu đã giải mã: ", decodedData);

                const idMatch = decodedData.match(/ID:\s*(\d+)/);
                const productId = idMatch ? idMatch[1] : null;

                if (!productId) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi',
                        text: 'Mã QR không hợp lệ. Không tìm thấy ID sản phẩm.'
                    });
                    return;
                }
                // Hàm để yêu cầu nhập số lượng
                const requestQuantity = async () => {
                    const {value: quantity} = await Swal.fire({
                        title: 'Nhập Số Lượng Sản Phẩm',
                        input: 'number',
                        inputLabel: 'Số lượng',
                        inputPlaceholder: 'Nhập số lượng',
                        inputAttributes: {
                            min: 1,
                            step: 1
                        },
                        showCancelButton: true,
                        confirmButtonText: 'Thêm',
                        cancelButtonText: 'Hủy',
                        inputValidator: (value) => {
                            if (!value || parseInt(value) <= 0 || isNaN(value)) {
                                return 'Vui lòng nhập số lượng hợp lệ!';
                            }
                        }
                    });
                    // Nếu người dùng nhập số lượng
                    if (quantity) {
                        try {
                            const response = await axios.get(`/admin/taiquay/add-sanpham-hdctqr/${productId}`, {
                                params: {
                                    quantity: parseInt(quantity),
                                    idHoaDon: idHoaDon
                                }
                            });
                            // Nếu thêm sản phẩm thành công, refresh lại danh sách
                            if (response.data && response.data.tongTien && response.data.listHDCT) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Thành Công',
                                    text: 'Sản phẩm đã được thêm vào giỏ hàng.',
                                    confirmButtonText: 'OK'
                                }).then((result) => {
                                    if (result.isConfirmed) {
                                        // Redirect đến trang chi tiết hóa đơn
                                        window.location.href = `/admin/taiquay/detail/${idHoaDon}`;
                                    }
                                });
                            }
                        } catch (error) {
                            // Xử lý lỗi từ server
                            if (error.response && error.response.data && error.response.data.errorSoLuong) {
                                // Hiển thị thông báo lỗi về số lượng sản phẩm
                                const result = await Swal.fire({
                                    icon: 'warning',
                                    title: 'Cảnh Báo',
                                    text: error.response.data.errorSoLuong,
                                    confirmButtonText: 'Đóng'
                                });
                                // Nếu người dùng bấm "Đóng", yêu cầu nhập lại số lượng
                                if (result.isConfirmed) {
                                    await requestQuantity();
                                }
                            } else {
                                // Xử lý các lỗi khác
                                console.error("Lỗi khi thêm sản phẩm vào giỏ hàng:", error);
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Lỗi',
                                    text: 'Có lỗi xảy ra, vui lòng thử lại.'
                                });
                            }
                        }
                    }
                };
                // Gọi hàm yêu cầu nhập số lượng nếu số lượng chưa hợp lệ
                await requestQuantity();
            }
            if (isCameraOn) {
                requestAnimationFrame(tick);
            }
        } else {
            console.log("Video not ready, waiting...");
            setTimeout(() => {
                requestAnimationFrame(tick);
            }, 200);
        }
    }
    // Hàm format tiền tệ
    function formatCurrency(amount) {
        return new Intl.NumberFormat('vi-VN').format(amount);
    }
</script>
<!--js check add sp-->
<script>
    function checkAddProduct() {
        const currentUrl = window.location.href;
        if (currentUrl === "http://localhost:8080/admin/taiquay") {
            // Sử dụng SweetAlert2 để hiển thị thông báo
            Swal.fire({
                icon: 'warning',
                title: 'Thông báo',
                text: 'Vui lòng chọn hóa đơn trước khi thêm sản phẩm.',
                confirmButtonText: 'Đóng'
            });
        } else {
            // Nếu không phải trang taiquay, thực hiện chuyển trang bình thường
            window.location.href = document.querySelector('.taiquay a').getAttribute('th:href');
        }
    }
</script>
<!--js confirm print pdf for hd-->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const btnCheckout = document.getElementById('btnCheckout');
        const paymentForm = document.getElementById('paymentForm');
        // Kiểm tra đường dẫn hiện tại
        function isOnTaiQuayPage() {
            return window.location.pathname === '/admin/taiquay';
        }
        // Kiểm tra phương thức thanh toán
        function isPaymentMethodSelected() {
            const paymentMethods = document.getElementsByName("phuongThucThanhToan");
            return Array.from(paymentMethods).some(method => method.checked);
        }
        function checkDiaChiRequired() {
            const khachHang = document.getElementById("khachHangId");
            const diaChi = document.getElementById("diaChi");
            // Kiểm tra nếu có khách hàng nhưng chưa có địa chỉ
            if (khachHang && khachHang.value.trim() !== "" &&
                (!diaChi || diaChi.value.trim() === "")) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Thông báo',
                    text: 'Vui lòng nhập địa chỉ cho khách hàng trước khi thanh toán!',
                    confirmButtonText: 'Nhập địa chỉ',
                    preConfirm: () => {
                        // Hiển thị form nhập địa chỉ
                        const addressForm = document.getElementById('addressForm');
                        if (addressForm) {
                            addressForm.style.display = 'block';
                        }
                    }
                });
                return false;
            }
            return true;
        }
        btnCheckout.addEventListener('click', function(event) {
            const khachHang = document.getElementById("khachHangId");
            const addressForm = document.getElementById('addressForm');
            const diaChi = document.getElementById("diaChi");

            // Nếu có khách hàng nhưng không có địa chỉ, tự động hiển thị form
            if (khachHang && khachHang.value.trim() !== "" &&
                (!diaChi || diaChi.value.trim() === "")) {
                if (addressForm) {
                    addressForm.style.display = 'block';
                }
            }
            // Nếu đang ở trang danh sách, không cho phép thanh toán
            if (isOnTaiQuayPage()) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Thông báo',
                    text: 'Bạn cần chọn một hóa đơn để tiến hành thanh toán!',
                    confirmButtonText: 'OK'
                });
                return;
            }
            // Lấy ID hóa đơn từ URL
            const pathParts = window.location.pathname.split('/');
            const hoaDonId = pathParts[pathParts.length - 1];

            // Kiểm tra phương thức thanh toán
            if (!isPaymentMethodSelected()) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Thông báo',
                    text: 'Bạn hãy chọn phương thức thanh toán!',
                    confirmButtonText: 'OK'
                });
                return;
            }

            // Kiểm tra khách hàng
            const khachHangInput = document.getElementById("khachHangId");
            if (!khachHangInput || khachHangInput.value.trim() === "") {
                Swal.fire({
                    icon: 'warning',
                    title: 'Thông báo',
                    text: 'Chưa có khách hàng trong hóa đơn! Bạn có muốn thêm khách hàng không?',
                    showCancelButton: true,
                    confirmButtonText: 'Có',
                    cancelButtonText: 'Không',
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Chuyển hướng đến trang thêm nhanh khách hàng
                        window.location.href = `/admin/taiquay/detail/${hoaDonId}`;
                    } else {
                        // Tiếp tục thanh toán với khách lẻ
                        submitPaymentForm(hoaDonId, true);
                    }
                });
            } else {
                // Nếu đã có khách hàng, gửi form
                submitPaymentForm(hoaDonId, false);
            }
            // Kiểm tra địa chỉ
            if (!checkDiaChiRequired()) {
                return;
            }
        });

        function submitPaymentForm(hoaDonId, themKhachHang) {
            // Kiểm tra địa chỉ trước khi submit
            if (!checkDiaChiRequired()) {
                return;
            }
            const formData = new FormData(paymentForm);
            formData.append("themKhachHang", themKhachHang);

            fetch(paymentForm.action + "?" + new URLSearchParams(formData), {
                method: "GET",
            })
                .then((response) => response.text())
                .then((pdfUrl) => handleInvoiceResponse(pdfUrl))
                .catch((error) => {
                    console.error("Lỗi khi xử lý thanh toán:", error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi',
                        text: 'Đã xảy ra lỗi trong quá trình thanh toán!',
                    }).then(() => {
                        window.location.href = "/admin/taiquay";
                    });
                });
        }

        function handleInvoiceResponse(pdfUrl) {
            if (pdfUrl) {
                Swal.fire({
                    title: 'Than htoán',
                    text: "Bạn có muốn xác nhận hóa đơn này?",
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Xác Nhận',
                    cancelButtonText: 'Hủy',
                }).then((result) => {
                    if (result.isConfirmed) {
                        Swal.fire({
                            title: 'Xác nhận thanh toán hóa đơn thành công!',
                            html: `
                        <div>
                            <p>Hóa đơn đã được lưu</p>
                            <a href="#" id="invoiceDownloadLink" style="color: blue; text-decoration: underline;">
                                Xem hóa đơn
                            </a>
                        </div>
                    `,
                            icon: 'success',
                            didRender: () => {
                                const downloadLink = document.getElementById('invoiceDownloadLink');
                                downloadLink.addEventListener('click', function(e) {
                                    e.preventDefault();
                                    window.open(pdfUrl, '_blank');
                                });
                            },
                            didClose: () => {
                                window.location.href = "/admin/taiquay";
                            }
                        });
                    } else {
                        window.location.href = "/admin/taiquay";
                    }
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi',
                    text: 'Không thể tạo file PDF!',
                }).then(() => {
                    window.location.href = "/admin/taiquay";
                });
            }
        }
    });
</script>

<!-- Thêm thư viện SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!--//-->
<!--lib qr-->
<script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<!--<script th:src="@{/javascript/locSanPhamTaiQuay.js}"></script>-->
<script>
    document.getElementById('toggleAddress').addEventListener('change', function () {
        const addressForm = document.getElementById('addressForm');
        if (this.checked) {
            addressForm.style.display = 'block';
        } else {
            addressForm.style.display = 'none';
        }
    });

</script>
<!--UPDATE SL SAN PHAM TRONG GH-->
<script>
    function updateQuantityDirectly(inputElement, hdctId) {
        // Lấy ID hóa đơn từ URL
        const pathParts = window.location.pathname.split('/');
        const hoaDonId = pathParts[pathParts.length - 1]; // Giả sử ID hóa đơn là phần cuối cùng của URL
        console.log(`Directly updating quantity for ID: ${hdctId}`);
        let newQuantity = parseInt(inputElement.value);
        const currentQuantity = parseInt(inputElement.getAttribute('data-current-quantity'));
        // Kiểm tra số lượng tồn kho
        const stockQuantity = parseInt(inputElement.getAttribute('data-stock-quantity')); // Thêm giá trị tồn kho
        // Kiểm tra số lượng hợp lệ
        if (isNaN(newQuantity) || newQuantity < 1) {
            Swal.fire({
                icon: 'error',
                title: 'Lỗi',
                text: 'Số lượng không hợp lệ. Vui lòng nhập số lượng lớn hơn 0.'
            });
            return;
        }
        // Kiểm tra số lượng tồn kho
        if (newQuantity > stockQuantity) {
            Swal.fire({
                icon: 'error',
                title: 'Lỗi',
                text: `Số lượng vượt quá số lượng tồn kho. Chỉ còn lại ${stockQuantity} sản phẩm.`
            });
            inputElement.value = currentQuantity; // Khôi phục lại giá trị cũ
            return;
        }
        //
        const delta = newQuantity - currentQuantity;
        // Log delta
        console.log(`Delta computed: ${delta}`);

        if (delta !== 0) {
            const url = `/admin/taiquay/update-sanpham-hdct/${hdctId}`;
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `delta=${delta}`
            })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        Swal.fire({
                            icon: 'warning',
                            title: 'Cảnh Báo',
                            text: data.error
                        });
                        inputElement.value = currentQuantity; // Khôi phục lại giá trị cũ
                    } else {
                        // Cập nhật số lượng tồn kho
                        // Redirect về trang chi tiết hóa đơn
                        window.location.href = `/admin/taiquay/detail/${hoaDonId}`;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi',
                        text: 'Có lỗi xảy ra, vui lòng thử lại.'
                    });
                    inputElement.value = currentQuantity; // Khôi phục lại giá trị cũ
                });
        }
    }

    function updateQuantity(hdctId, delta) {
        // Lấy ID hóa đơn từ URL
        const pathParts = window.location.pathname.split('/');
        const hoaDonId = pathParts[pathParts.length - 1]; // Giả sử ID hóa đơn là phần cuối cùng của URL
        const quantityInput = document.getElementById(`quantity-${hdctId}`);

        let currentQuantity = parseInt(quantityInput.value);
        let newQuantity = currentQuantity + delta;
        // Kiểm tra số lượng tồn kho trước khi thay đổi
        const stockQuantity = parseInt(quantityInput.getAttribute('data-stock-quantity')); // Lấy số lượng tồn kho

        if (newQuantity < 1) {
            Swal.fire({
                title: 'Xóa Sản Phẩm',
                text: 'Bạn có muốn xóa sản phẩm này khỏi giỏ hàng không?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Có, xóa ngay!',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Gọi API xóa sản phẩm
                    window.location.href = `/admin/taiquay/xoa-sanpham-hdct/${hdctId}`;
                }
            });
            return;
        }
        //kiem tra sl ton kho
        if (newQuantity > stockQuantity) {
            Swal.fire({
                icon: 'error',
                title: 'Lỗi',
                text: `Số lượng vượt quá số lượng tồn kho. Chỉ còn lại ${stockQuantity} sản phẩm.`
            });
            return;
        }
        // Cập nhật số lượng trong input
        quantityInput.value = newQuantity;
        // Cập nhật lại giá trị data-current-quantity trước khi gọi hàm khác
        quantityInput.setAttribute('data-current-quantity', newQuantity);

        const url = `/admin/taiquay/update-sanpham-hdct/${hdctId}`;
        console.log(`Sending request to update quantity for ID: ${hdctId} with delta: ${delta}`);
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `delta=${delta}`
        })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Cảnh Báo',
                        text: data.error
                    });
                    quantityInput.value = currentQuantity; // Khôi phục lại giá trị cũ
                } else {
                    // Cập nhật giá trị hiện tại
                    // Redirect về trang chi tiết hóa đơn
                    window.location.href = `/admin/taiquay/detail/${hoaDonId}`;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi',
                    text: 'Có lỗi xảy ra, vui lòng thử lại.'
                });
                quantityInput.value = currentQuantity; // Khôi phục lại giá trị cũ
            });
    }
</script>
<!--hủy phiếu  giảm giá-->
<script>
    $(document).ready(function () {
        // Xử lý khi nhấn nút hủy phiếu giảm giá
        $('#huyPhieuGiamGiaBtn').on('click', function () {
            if (idHoaDon == null || idHoaDon === undefined) {
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi',
                    text: 'Không tìm thấy ID hóa đơn. Vui lòng thử lại.',
                    timer: 1500,
                    showConfirmButton: false
                });
                return;
            }
            Swal.fire({
                title: 'Xác nhận hủy phiếu giảm giá',
                text: 'Bạn có chắc chắn muốn bỏ chọn phiếu giảm giá này không?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Có, hủy ngay!',
                cancelButtonText: 'Không, giữ lại'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '/admin/taiquay/huy-phieu-giam-gia/' + idHoaDon,
                        method: 'GET',
                        dataType: 'json', // Thêm dataType để xử lý response
                        success: function (response) {
                            // Kiểm tra response trước khi sử dụng
                            if (response && response.tongTien) {
                                $('#tongTien').text(response.tongTien + 'đ');
                                // Chuyển đổi giá trị về số
                                let tongTien = parseFloat(response.tongTien.replace(/[^\d.-]/g, ''));
                                let tongTienSauGiam = parseFloat(response.tongTienSauGiam.replace(/[^\d.-]/g, ''));
                                // Tính số tiền giảm
                                let soTienGiam = tongTien - tongTienSauGiam;
                                // Cập nhật tổng tiền ban đầu
                                $('#subtotal').text(response.tongTien + 'đ');
                                // Cập nhật tổng tiền sau giảm
                                $('#totalAfterDiscount').text(response.tongTien + 'đ');
                                // Đặt lại số tiền giảm giá về 0
                                $('#discount').text(soTienGiam > 0
                                    ? soTienGiam.toLocaleString('vi-VN', {minimumFractionDigits: 0, maximumFractionDigits: 0}) + ' đ'
                                    : '0 đ'
                                );
                                // Xóa mã phiếu giảm giá
                                $('#maPhieuGiamGia').val('');
                                // Ẩn nút hủy
                                $('#huyPhieuGiamGiaBtn').hide();
                                // Thông báo thành công
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Đã hủy phiếu giảm giá',
                                    text: 'Tổng tiền đã được hoàn nguyên.',
                                    timer: 1500,
                                    showConfirmButton: false
                                });
                            } else {
                                throw new Error('Phản hồi không hợp lệ');
                            }
                        },
                        error: function (xhr, status, error) {
                            console.error('Chi tiết lỗi:', xhr, status, error);
                            // Xử lý lỗi chi tiết hơn
                            let errorMessage = 'Có lỗi xảy ra';
                            if (xhr.responseJSON && xhr.responseJSON.error) {
                                errorMessage = xhr.responseJSON.error;
                            } else if (xhr.statusText) {
                                errorMessage = xhr.statusText;
                            }
                            Swal.fire({
                                icon: 'error',
                                title: 'Lỗi',
                                text: errorMessage,
                                timer: 2000,
                                showConfirmButton: false
                            });
                        }
                    });
                }
            });
        });
    });
</script>
</html>