<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ban Hang</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
    <link rel="stylesheet" th:href="@{/css/admin.css}">
    <link rel="stylesheet" th:href="@{/css/taiquay.css}">
    <!-- Thêm vào head hoặc trước khi đóng body -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<style>
    .alert {
        padding: 10px;
        margin-bottom: 15px;
        border: 1px solid transparent;
        border-radius: 4px;
    }

    .alert-warning {
        color: #856404;
        background-color: #fff3cd;
        border-color: #ffeeba;
    }
    .switch {
        position: relative;
        display: inline-block;
        width: 34px;
        height: 20px;
    }

    .switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        border-radius: 20px;
    }

    .slider:before {
        position: absolute;
        content: "";
        height: 14px;
        width: 14px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        border-radius: 50%;
        transition: 0.4s;
    }

    input:checked + .slider {
        background-color: #2196F3;
    }

    input:checked + .slider:before {
        transform: translateX(14px);
    }
    .diaChiCheck {
        margin-top: 20px;
    }

    #addressForm {
        display: flex;
        flex-wrap: wrap; /* Đảm bảo form phản hồi tốt trên các màn hình nhỏ */
        align-items: center; /* Căn giữa theo chiều dọc */
        gap: 10px; /* Khoảng cách giữa các phần tử */
    }

    #addressForm label {
        font-size: 14px;
        color: #333;
        margin-right: 10px;
    }

    #addressForm input[type="text"] {
        padding: 8px 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        flex: 1; /* Cho phép input giãn nở */
        min-width: 200px; /* Đảm bảo kích thước tối thiểu */
        font-size: 14px;
    }

    #addressForm button {
        padding: 8px 15px;
        background-color: #007bff;
        color: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.3s;
    }

    #addressForm button:hover {
        background-color: #0056b3;
    }

</style>
<body class="container-fluid">
<article th:replace="~{admin/fragments/article :: article}"></article>
<header th:replace="~{admin/fragments/header :: header}"></header>
<nav th:replace="~{admin/fragments/nav :: nav}"></nav>

<section class="page-content my-4">
    <h4 style="margin-left: 30px; margin-top: 10px; margin-bottom: 30px"><b>Bán hàng tại quầy</b></h4>
<!--    <h5>Tên nhân viên: <span th:text="${nhanvien.ten}">Tên nhân viên</span></h5>-->
    <form id="createInvoiceForm">
        <button id="btnCreateInvoice" style="background-color: #ff6b6b; border-radius: 20px; border: 1px solid #ccc;"
                type="button"><i class="bi bi-align-center">Tạo Hóa Đơn</i></button>
    </form>
    <div class="container">
        <div id="invoiceList" style="margin-top: 20px;">
            <ul style="list-style-type: none; padding: 0; display: flex; flex-wrap: wrap;">
                <li class="invoice-item" th:each="hoaDon : ${listHD}" th:attr="data-id=${hoaDon.id}"
                    style="margin-right: 15px;">
                    <a th:href="@{/admin/taiquay/detail/{id}(id=${hoaDon.id})}"
                       th:text="'Hóa đơn ' + ${hoaDon.id}" style="text-decoration: none;" class="invoice-link"
                       th:attr="data-id=${hoaDon.id}"
                    ></a>
                    <span class="invoice-close-btn">&times;</span>
                </li>
            </ul>
        </div>
        <!-- Thông báo thành công -->
        <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
            <strong>Thành công!</strong> <span th:text="${successMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        <!-- Thông báo lỗi -->
<!--        <div th:if="${errorSoLuong}" class="alert alert-warning alert-dismissible fade show" role="alert">-->
<!--            <strong>Cảnh báo!</strong> <span th:text="${errorSoLuong}"></span>-->
<!--            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>-->
<!--        </div>-->
        <div class="section">
            <div>
                <div class="d-flex justify-content-between">
                    <div>
                        <button class="btn btn-dark" onclick="toggleCamera()">Quét QR</button>
                        <div style="margin-bottom: 20px; margin-top: 20px">
                            <video id="qr-video" width="240" height="160" style="display: none;"></video>
                            <canvas id="qr-canvas" width="400" height="300" style="display:none;"></canvas>
                        </div>
                    </div>
                </div>

                <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

                <a class="taiquay"><a th:href="@{/admin/taiquay/sanpham#sanpham}">
                    <button class="btn btn-light">Thêm Sản Phẩm</button>
                </a></a>
            </div>
            <div class="container-row">
                <div class="custom-table">
                    <div class="custom-table1">
                        <table class="table table-bordered table-hover text-center ">
                            <thead class="table-light">
                            <tr>
                                <th scope="col">STT</th>
                                <th scope="col">Sản Phẩm</th>
                                <th scope="col">SL</th>
                                <th scope="col">Đơn Giá</th>
                                <th scope="col">Tổng</th>
                                <th scope="col">Thao Tác</th>
                            </tr>
                            </thead>
                            <tbody id="cartTable1">
                            <tr th:each="hdct,stt : ${listHDCT}">
                                <td th:text="${stt.index + 1}"></td>
                                <td th:text="${hdct.sanPhamChiTiet.sanPham.tenSanPham}"></td>
                                <td>
                                    <button class="btn btn-sm btn-light" style="margin-right: 3px"
                                            th:attr="onclick='updateQuantity(' + ${hdct.id} + ', -1)'">-</button>
                                    <span th:text="${hdct.soLuong}"></span>
                                    <button class="btn btn-sm btn-light" style="margin-left: 3px"
                                            th:attr="onclick='updateQuantity(' + ${hdct.id} + ', 1)'">+</button>
                                </td>
                                <td th:text="${#numbers.formatDecimal(hdct.sanPhamChiTiet.gia, 1, 'COMMA', 0, 'POINT')} + 'đ'"></td>
                                <!--                                <p class="price" th:text="${#numbers.formatDecimal(sanpham.gia, 1, 'COMMA', 0, 'POINT')} + 'đ'"></p>-->
                                <td th:text="${#numbers.formatDecimal(hdct.sanPhamChiTiet.gia.multiply(hdct.soLuong),1, 'COMMA', 0, 'POINT')}+ 'đ'"></td>
                                <td><a th:href="@{/admin/taiquay/xoa-sanpham-hdct/{id}(id=${hdct.id})}"
                                       class="btn btn-light" title="Xóa"><i class="bi bi-trash-fill fs-5"></i></a></td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="custom-note-row">
                        <span class="note">Tổng tiền đơn hàng : </span>
                        <span class="total"
                              th:text="${#numbers.formatDecimal(tongTien, 1, 'COMMA', 0, 'POINT')}"></span> vnđ
                    </div>

<!--                    <div class="diaChiCheck">-->
<!--                        <form id="addressForm" style="display: none;" th:action="@{/admin/taiquay/cap-nhat-hoa-don}" method="post">-->
<!--                            <label style="margin: 15px;">Địa chỉ: <span th:text="${hoaDon.diaChi == null ? '' : hoaDon.diaChi.diaChiChiTiet}"></span></label>-->
<!--                                    <div class="input-group">-->
<!--                                        <input type="hidden" name="idHoaDon" th:value="${hoaDon.id}" />-->
<!--                                        <input type="text" id="diaChi" name="diaChi" th:value="${diaChi}" />-->
<!--                                        <button type="submit">Cập nhật địa chỉ</button>-->
<!--                                    </div>-->
<!--                        </form>-->
<!--                    </div>-->
                </div>
                <div class="payment-info">
                    <p style="margin-top: 7px;margin-bottom: 7px;"><b><i class="bi bi-diamond-fill fs3">Thông tin thanh
                        toán</i></b></p>

                    <div style="display: flex; align-items: center; gap: 20px;">
<!--                        <script>-->
<!--                            // Hàm hiển thị thông báo-->
<!--                            function showPrompt(soDienThoai) {-->
<!--                                const isAdd = confirm(-->
<!--                                    `Không tìm thấy khách hàng với số điện thoại: ${soDienThoai}. Bạn có muốn thêm khách hàng mới không?`-->
<!--                                );-->
<!--                                if (isAdd) {-->
<!--                                    // Chuyển hướng đến form thêm khách hàng-->
<!--                                    window.location.href = '/admin/taiquay/add?soDienThoai=' + soDienThoai;-->
<!--                                }-->
<!--                            }-->
<!--                        </script>-->

                        <form th:action="@{/admin/taiquay/tim-kiem}" method="get"
                              style="display: flex; align-items: center; gap: 10px;">
                            <input type="text" id="soDienThoai" name="soDienThoai" required
                                   style="padding: 5px; border-radius: 5px; border: 1px solid #ddd; width: 200px;">
                            <button type="submit"
                                    style="background-color: #2c3e50; color: white;margin-bottom: 5px; padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer;">
                                Tìm kiếm KH
                            </button>
                        </form>
                        <div>
                            <label class="switch">
                                <input type="checkbox" id="toggleAddress" />
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div id="themnhanhkhachhang" class="dialogmodal">
                        <div class="modal__center">
                            <div class="thongBao">
                            <p>Hiện không có số điện thoại này! Bạn có muốn thêm mới không?</p>
                            <a href="#themnhanhkhachhang1"><button>Có</button></a>
                            <a href=""><button>Không</button></a>
                            <a href="#" class="modal__close">&times;</a>
                            </div>
                        </div>
                        </div>

                        <div id="themnhanhkhachhang1" class="dialogmodal">
                            <div class="modal__center">
<!--                                <div th:if="${alertMessage}" class="alert alert-warning">-->
<!--                                    <p th:text="${alertMessage}"></p>-->
<!--                                </div>-->
                        <form th:action="@{/admin/taiquay/add}" th:object="${khachHangThemNhanh}" method="post">
                            <div class="row">

                                <div class="col-sm-6">
                                    <label class="form-label">Ảnh Đại Diện</label>
                                    <input type="text" class="form-control" th:field="*{anhUrl}">
                                </div>

                                <div class="col-sm-6">
                                    <label class="form-label">Tên Khách Hàng</label>
                                    <input type="text" class="form-control" th:field="*{ten}">
                                    <span th:if="${#fields.hasErrors('ten')}" th:errors="*{ten}"></span>

                                </div>

                                <div class="col-sm-6">
                                    <label  class="form-label">Ngày Sinh</label>
                                    <input type="date" class="form-control" th:field="*{ngaySinh}">
                                    <span th:if="${#fields.hasErrors('ngaySinh')}" th:errors="*{ngaySinh}"></span>
                                </div>

                                <div class="col-sm-6">
                                    <label class="form-label">Giới Tính</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name=""  value="1" th:field="*{gioiTinh}" checked>
                                        <label class="form-check-label">
                                            Nam
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name=""  value="0" th:field="*{gioiTinh}">
                                        <label class="form-check-label">
                                            Nu
                                        </label>
                                    </div>
                                    <span th:if="${#fields.hasErrors('gioiTinh')}" th:errors="*{gioiTinh}"></span>

                                </div>

                                <div class="col-sm-6">
                                    <label  class="form-label">SDT</label>
                                    <input type="number" class="form-control"  th:field="*{soDienThoai}">
<!--                                    <span th:if="${#fields.hasErrors('soDienThoai')}" th:errors="*{soDienThoai}"></span>-->

                                </div>

                                <div class="col-sm-6">
                                    <label class="form-label">Email</label>
                                    <input type="text" class="form-control"  th:field="*{email}">
                                    <span th:if="${#fields.hasErrors('email')}" th:errors="*{email}"></span>
                                </div>


                                <!--    <div class="col-sm-6">-->
                                <!--      <label class="form-label">Tài Khoản</label>-->
                                <!--      <select class="form-select" aria-label="Default select example" th:field="*{taiKhoan}">-->
                                <!--        <option th:each="taiKhoan : ${listTK}" th:value="${taiKhoan.id}"  th:text="${taiKhoan.id}"></option>-->
                                <!--      </select>-->
                                <!--    </div>-->

                                <div class="col-sm-6">
                                    <label class="form-label">Trạng Thái</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="" value="0" th:field="*{trangThai}">
                                        <label class="form-check-label">
                                            Không Hoạt Động
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name=""  value="1" th:field="*{trangThai}">
                                        <label class="form-check-label">
                                            Hoạt Động
                                        </label>
                                    </div>
                                    <span th:if="${#fields.hasErrors('trangThai')}" th:errors="*{trangThai}"></span>

                                </div>
                                <button type="submit"
                                        style="background-color: #2c3e50; color: white;margin-bottom: 5px; padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer;">
                                    Thêm Khách Hàng
                                </button>
                            </div>
                            <a href="#" class="modal__close">&times;</a>
                        </form>
                            </div>
                        </div>
                    </div>
                    <div class="half">
                        <!-- Tên Khách Hàng -->
                        <div style="display: flex; align-items: center; margin-bottom: 5px; width: 300px;">
                            <span style="font-size: 14px; margin-top: 10px;">Tên Khách Hàng:</span>
                            <span th:text="${khachHang != null ? khachHang.ten : 'Khách lẻ'}"
                                  style="font-size: 14px;margin-top: 10px; color: #2c3e50; background-color: #f0f0f0; padding: 5px 10px; border-radius: 5px; margin-left: 10px;"></span>
                        </div>
                        <!-- Số Điện Thoại -->
                        <div style="display: flex; align-items: center;width: 300px;">
                            <span style="font-size: 14px; margin-top: 10px;">Số điện thoại:</span>
                            <span th:text="${khachHang != null ? khachHang.soDienThoai : ''}"
                                  style="font-size: 14px; margin-top: 10px; color: #2c3e50; background-color: #f0f0f0; padding: 5px 10px; border-radius: 5px; margin-left: 10px;"></span>
                        </div>
                    </div>

                    <div style="display: flex; align-items: center; gap: 20px;">
                        <form id="formGiamGia" th:action="@{/admin/taiquay/kiemtrama}" method="post"
                              class="discount-form">
                            <input type="text" name="maphieugiamgia" placeholder="Nhập mã giảm giá"
                                   th:value="${maPhieuGiamGia}"/>
                            <button type="submit" class="apply-button"
                                    style="background-color: #2c3e50; color: white;margin-bottom: 5px; padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer;">
                                Áp dụng
                            </button>
                        </form>
                        <div class="discount-code-container">
                            <a class="taiquay" th:href="@{/admin/taiquay/phieugiamgia#phieugiamgia}">
                                <button id="choose" class="discount-code-button"
                                        style="background-color: #2c3e50; color: white;margin-bottom: 5px; padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer;">
                                    Mã PGG
                                </button>
                            </a>
                        </div>
                    </div>

                    <div id="phieugiamgia" class="dialogmodal">
                        <div class="modal__center">
                            <div th:replace="~{admin/BanhangTaiQuay/tablePhieuGiamGia :: form}"></div>
                            <div th:replace="~{admin/BanhangTaiQuay/tablePhieuGiamGia :: table}"></div>


                            <!--                            <a th:href="@{/admin/taiquay/detail/{id}(id=${idHoaDon})}" class="modal__close">&times;</a>-->
                            <a th:href="@{${idHoaDon != null ? '/admin/taiquay/detail/' + idHoaDon : '/admin/taiquay'}}"
                               class="modal__close">&times;</a>
                            <div>
                                <div class="d-flex align-items-center">
                                    <label for="itemsPerPage" class="me-2">Xem</label>
                                    <select class="form-select form-select-sm" id="itemsPerPage" name="size"
                                            style="width: 80px;"
                                            onchange="changeItemsPerPage()">
                                        <option value="5" th:selected="${size == 5}">5</option>
                                        <option value="10" th:selected="${size == 10}">10</option>
                                        <option value="15" th:selected="${size == 15}">15</option>
                                        <option value="20" th:selected="${size == 20}">20</option>
                                    </select>
                                </div>
                                <div th:replace="~{admin/BanhangTaiQuay/tablePhieuGiamGia :: nav}"></div>
                            </div>
                            <div th:replace="~{admin/BanhangTaiQuay/tablePhieuGiamGia :: script}"></div>
                        </div>
                    </div>
                    <!--                    <form id="formGiamGia" th:action="@{/admin/taiquay/kiemtrama}" method="get">-->
                    <!--                        <input type="text" name="maPhieuGiamGia" th:value="${maPhieuGiamGia}"/>-->
                    <!--                        &lt;!&ndash; Sử dụng thuộc tính đúng &ndash;&gt;-->
                    <!--                        <button type="submit">Áp dụng</button>-->
                    <!--                    </form>-->


                    <p style="font-size: 14px; margin-top: 10px;">Tiền Tạm Tính: <span id="subtotal"
                               th:text="${#numbers.formatDecimal((tongTien != null ? tongTien : 0), 1, 'COMMA', 0, 'POINT')} + 'đ'">0</span>
                    </p>
                    <p style="font-size: 14px;">Số Tiền Giảm Giá: <span id="discount">0</span> đ</p>

                    <p>Tổng tiền sau khi áp dụng mã giảm giá:

                        <!--                        <span th:text="${#numbers.formatDecimal((tongTienSauGiam != null ? tongTienSauGiam : tongTien), 1, 'COMMA', 0, 'POINT')} + 'đ'"></span>-->
<!--                        <span th:text="${tongTienSauGiam != null ? tongTienSauGiam : (tongTien != null ? tongTien : 0)}"></span>-->
                        <span th:text="${tongTienSauGiam == null || tongTienSauGiam == 0 ? #numbers.formatDecimal(tongTien, 1, 'COMMA', 0, 'POINT') : #numbers.formatDecimal(tongTienSauGiam, 1, 'COMMA', 0, 'POINT')}"></span>


                    </p>
                    <div th:if="${error}">
                        <p style="color: red;" th:text="${error}"></p>
                    </div>

                    <label style="margin-right: 50px;font-size: 14px;">Khách thanh toán: </label>
                    <a class="taiquay">
                        <a href="#thanhtoan">
                            <button class="bi bi-card-text" style="background-color: #2c3e50;"></button>
                        </a>
                    </a>
                    <div id="thanhtoan" class="modalthanhtoan">
                        <div class="modal__centerthanhtoan">
                            <form action="/admin/taiquay/thanhtoan" method="get" id="paymentForm" target="pdfWindow"
                                  class="thanhtoan">
                                <div class="mb-3">
                                    <label class="col-3" style="font-size: 14px;margin-top: 10px;">Khách cần
                                        trả:</label>
                                    <b><span id="tongTien" style="font-size: 14px;"
                                             th:text="${tongTienSauGiam == null || tongTienSauGiam == 0 ? #numbers.formatDecimal(tongTien, 1, 'COMMA', 0, 'POINT') : #numbers.formatDecimal(tongTienSauGiam, 1, 'COMMA', 0, 'POINT') +' đ'}"></span></b>
                                    <input type="hidden" name="tongTien"
                                           th:value="${#numbers.formatDecimal((tongTienSauGiam != null ? tongTienSauGiam : (tongTien != null ? tongTien : 0)), 1, 'COMMA', 0, 'POINT') + ' đ'}"/>
                                </div>

                                <div class="received">
                                    <script src="https://cdnjs.cloudflare.com/ajax/libs/big.js/6.0.3/big.min.js"></script>
                                    <label>Số tiền khách đưa:</label>
                                    <input type="number" id="soTienKhachDua" name="soTienKhachDua"
                                           style="width: 200px;height: 20px" step="0.01" required
                                           oninput="tinhTienThua()"/>
                                </div>
                                <div class="change">
                                    <label>Tiền thừa:</label>
                                    <span id="tienThua">0</span>
                                </div>

                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <label style="font-size: 13px; margin-right: 10px;margin-top: 10px;">Phương
                                        thức:</label>

                                    <div class="form-check" style="display: flex; align-items: center;">
                                        <input class="form-check-input" style="margin-bottom: 5px;margin-top: 10px;"
                                               type="radio" name="phuongThucThanhToan" value="1">
                                        <label class="form-check-label"
                                               style="margin-right: 15px; margin-left: 5px;margin-top: 10px;font-size: 12px;">Tiền
                                            Mặt</label>
                                    </div>

                                    <div class="form-check" style="display: flex; align-items: center;">
                                        <input class="form-check-input" type="radio"
                                               style="margin-bottom: 5px;margin-top: 10px;" name="phuongThucThanhToan"
                                               value="2">
                                        <label class="form-check-label"
                                               style="margin-right: 15px;margin-left: 5px;margin-top: 10px;font-size: 12px;">Chuyển
                                            Khoản</label>
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <label style="font-size: 14px; margin-right: 10px;margin-top: 10px;">Ghi
                                        Chú:</label>
                                    <div class="form-check" style="display: flex; align-items: center;">
                                        <input type="text" class="col-7" name="ghiChu"
                                               style="height: 20px;width:200px;margin-top: 10px;" th:value="${ghiChu}">
                                    </div>
                                </div>
                                <input type="hidden" name="maPhieuGiamGia" th:value="${maPhieuGiamGia}">
                                <button id="btnCheckout" type="submit"
                                        style="margin-top: 10px;background-color: #2c3e50;">Thanh Toán
                                </button>
                                <a href="#" class="modal__close">&times;</a>
                            </form>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </script>

    <!-- ComboBox Lọc Kích Cỡ -->
    <div id="sanpham" class="dialogmodal">
        <div class="modal__center">
            <h4>Sản phẩm</h4>
            <div th:replace="~{admin/BanhangTaiQuay/SPCTTable :: form}"></div>
            <!-- Table Sản phẩm -->
            <div th:replace="~{admin/BanhangTaiQuay/SPCTTable :: table}"></div>
            <!--            <a th:href="@{/admin/taiquay/detail/{id}(id=${idHoaDon})}" class="modal__close">&times;</a>-->
            <a th:href="@{${idHoaDon != null ? '/admin/taiquay/detail/' + idHoaDon : '/admin/taiquay'}}"
               class="modal__close">&times;</a>

            <div style="margin-top: 15px" class="d-flex align-items-center">
                <label for="itemsPerPage" class="me-2">Xem</label>
                <select class="form-select form-select-sm" id="itemsPerPage2" name="size"
                        onchange="changeItemsPerPage2()" style="width: 80px;">
                    <option value="5" th:selected="${size == 5}">5</option>
                    <option value="10" th:selected="${size == 10}">10</option>
                    <option value="15" th:selected="${size == 15}">15</option>
                    <option value="20" th:selected="${size == 20}">20</option>
                </select>
            </div>
            <div th:replace="~{admin/BanhangTaiQuay/SPCTTable :: nav}"></div>
            <div th:replace="~{admin/BanhangTaiQuay/SPCTTable :: script}"></div>
        </div>
    </div>
</section>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</section>
</body>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/javascript/admin.js}"></script>
<script th:src="@{/javascript/thanhtoan.js}"></script>
<script th:src="@{/javascript/taiquay.js}"></script>
<script>
    // Gán giá trị idHoaDon từ server qua Thymeleaf
    let idHoaDon = [[${idHoaDon}]];
    console.log("idHoaDon: " + idHoaDon);

    // Khởi tạo các biến cần thiết cho camera
    const video = document.getElementById('qr-video');
    const canvas = document.getElementById('qr-canvas');
    const context = canvas.getContext('2d');
    let isCameraOn = false;

    // Hàm toggle camera khi nhấn nút Quét QR
    function toggleCamera() {
        const currentUrl = window.location.href;
        if (currentUrl.includes("http://localhost:8080/admin/taiquay")) {
            // Kiểm tra nếu idHoaDon chưa được chọn hoặc là giá trị mặc định (1)
            if (!idHoaDon || idHoaDon === 1) {
                alert("Vui lòng chọn hóa đơn trước khi quét QR.");
                return;
            }
            // Thực hiện mở/tắt camera
            if (isCameraOn) {
                // Tắt camera
                video.style.display = "none";
                canvas.style.display = "none";
                isCameraOn = false;
                console.log("Camera closed");
            } else {
                // Bật camera
                startCamera();
                isCameraOn = true;
                console.log("Camera opened");
            }
        }
    }

    // Hàm khởi động camera
    function startCamera() {
        navigator.mediaDevices.getUserMedia({video: {facingMode: 'environment'}})
            .then(stream => {
                video.srcObject = stream;
                video.play();
                video.onloadedmetadata = () => {
                    console.log("Video metadata loaded");
                requestAnimationFrame(tick);
                };
            })
            .catch(error => {
                console.error('Unable to access the camera/webcam.', error);
                alert("Không thể truy cập camera.");
            });

        video.style.display = 'block';
        canvas.style.display = 'none';
    }

    // get qr scan to controller
    // async function tick() {
    //     console.log("Video dimensions:", video.videoWidth, video.videoHeight);
    //     if (video.readyState === video.HAVE_ENOUGH_DATA) {
    //         console.log("Tick function is running...");
    //         canvas.height = video.videoHeight;
    //         canvas.width = video.videoWidth;
    //         context.drawImage(video, 0, 0, canvas.width, canvas.height);
    //         const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
    //         const code = jsQR(imageData.data, imageData.width, imageData.height);
    //
    //         if (code) {
    //             const qrData = code.data;
    //             console.log("Dữ liệu mã QR: ", qrData);
    //             const decodedData = decodeURIComponent(escape(qrData));
    //             console.log("Dữ liệu đã giải mã: ", decodedData);
    //
    //             const idMatch = decodedData.match(/ID:\s*(\d+)/);
    //             const productId = idMatch ? idMatch[1] : null;
    //
    //             if (!productId) {
    //                 Swal.fire({
    //                     icon: 'error',
    //                     title: 'Lỗi',
    //                     text: 'Mã QR không hợp lệ. Không tìm thấy ID sản phẩm.'
    //                 });
    //                 return;
    //             }
    //
    //             // Hiển thị input số lượng với SweetAlert2
    //             const { value: quantity } = await Swal.fire({
    //                 title: 'Nhập Số Lượng Sản Phẩm',
    //                 input: 'number',
    //                 inputLabel: 'Số lượng',
    //                 inputPlaceholder: 'Nhập số lượng',
    //                 inputAttributes: {
    //                     min: 1,
    //                     step: 1
    //                 },
    //                 showCancelButton: true,
    //                 confirmButtonText: 'Thêm',
    //                 cancelButtonText: 'Hủy',
    //                 inputValidator: (value) => {
    //                     if (!value || parseInt(value) <= 0 || isNaN(value)) {
    //                         return 'Vui lòng nhập số lượng hợp lệ!';
    //                     }
    //                 }
    //             });
    //
    //             // Nếu người dùng nhập số lượng
    //             // if (quantity) {
    //             //     try {
    //             //         const response = await axios.get(`/admin/taiquay/add-sanpham-hdctqr/${productId}`, {
    //             //             params: {
    //             //                 quantity: parseInt(quantity),
    //             //                 idHoaDon: idHoaDon
    //             //             }
    //             //         });
    //             //         // Kiểm tra lỗi số lượng
    //             //         if (response.data.errorSoLuong) {
    //             //             Swal.fire({
    //             //                 icon: 'warning',
    //             //                 title: 'Cảnh Báo',
    //             //                 text: response.data.errorSoLuong,
    //             //                 confirmButtonText: 'Nhập lại'
    //             //             }).then(() => {
    //             //                 // Gọi lại hàm tick để quét lại
    //             //                 tick();
    //             //             });
    //             //             return;
    //             //         }
    //             //
    //             //         // Kiểm tra và xử lý response an toàn
    //             //         if (response.data && response.data.tongTien && response.data.listHDCT) {
    //             //             // Cập nhật giỏ hàng bằng JavaScript
    //             //             updateCartDynamically(response.data);
    //             //
    //             //             // Thông báo thành công
    //             //             Swal.fire({
    //             //                 icon: 'success',
    //             //                 title: 'Thành Công',
    //             //                 text: 'Sản phẩm đã được thêm vào giỏ hàng.',
    //             //                 timer: 1000,
    //             //                 showConfirmButton: false
    //             //             });
    //             //         } else {
    //             //             // Nếu response không đúng định dạng
    //             //             throw new Error('Dữ liệu trả về không hợp lệ');
    //             //         }
    //             //
    //             //     } catch (error) {
    //             //         console.error("Lỗi khi thêm sản phẩm vào giỏ hàng:", error);
    //             //
    //             //         // Log chi tiết lỗi
    //             //         if (error.response) {
    //             //             console.error("Response Error:", error.response.data);
    //             //             console.error("Status:", error.response.status);
    //             //         }
    //             //
    //             //         Swal.fire({
    //             //             icon: 'error',
    //             //             title: 'Lỗi',
    //             //             text: error.message || 'Có lỗi xảy ra, vui lòng thử lại.'
    //             //         });
    //             //     }
    //             // }
    //             if (quantity) {
    //                 try {
    //                     const response = await axios.get(`/admin/taiquay/add-sanpham-hdctqr/${productId}`, {
    //                         params: {
    //                             quantity: parseInt(quantity),
    //                             idHoaDon: idHoaDon
    //                         }
    //                     });
    //
    //                     // Nếu thêm sản phẩm thành công, refresh lại danh sách
    //                     if (response.data && response.data.tongTien && response.data.listHDCT) {
    //                         // Gọi AJAX để lấy lại toàn bộ danh sách hóa đơn chi tiết
    //                         await refreshHoaDonChiTiet();
    //
    //                         Swal.fire({
    //                             icon: 'success',
    //                             title: 'Thành Công',
    //                             text: 'Sản phẩm đã được thêm vào giỏ hàng.',
    //                             timer: 1000,
    //                             showConfirmButton: false
    //                         });
    //                     } else {
    //                         throw new Error('Dữ liệu trả về không hợp lệ');
    //                     }
    //
    //                 } catch (error) {
    //                     if (error.response && error.response.data && error.response.data.errorSoLuong) {
    //                         // Hiển thị thông báo lỗi về số lượng sản phẩm
    //                         Swal.fire({
    //                             icon: 'warning',
    //                             title: 'Cảnh Báo',
    //                             text: error.response.data.errorSoLuong,
    //                             confirmButtonText: 'Đóng'
    //                         });
    //                     } else {
    //                         // Xử lý các lỗi khác
    //                         console.error("Lỗi khi thêm sản phẩm vào giỏ hàng:", error);
    //                         Swal.fire({
    //                             icon: 'error',
    //                             title: 'Lỗi',
    //                             text: 'Có lỗi xảy ra, vui lòng thử lại.'
    //                         });
    //                     }
    //                 }
    //             }
    //         }
    //         if (isCameraOn) {
    //             requestAnimationFrame(tick);
    //         }
    //     } else {
    //         console.log("Video not ready, waiting...");
    //         setTimeout(() => {
    //             requestAnimationFrame(tick);
    //         }, 200);
    //     }
    //
    // }


    // tick new validation
    async function tick() {
        console.log("Video dimensions:", video.videoWidth, video.videoHeight);
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            console.log("Tick function is running...");
            canvas.height = video.videoHeight;
            canvas.width = video.videoWidth;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);

            if (code) {
                const qrData = code.data;
                console.log("Dữ liệu mã QR: ", qrData);
                const decodedData = decodeURIComponent(escape(qrData));
                console.log("Dữ liệu đã giải mã: ", decodedData);

                const idMatch = decodedData.match(/ID:\s*(\d+)/);
                const productId = idMatch ? idMatch[1] : null;

                if (!productId) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi',
                        text: 'Mã QR không hợp lệ. Không tìm thấy ID sản phẩm.'
                    });
                    return;
                }

                // Hàm để yêu cầu nhập số lượng
                const requestQuantity = async () => {
                    const { value: quantity } = await Swal.fire({
                        title: 'Nhập Số Lượng Sản Phẩm',
                        input: 'number',
                        inputLabel: 'Số lượng',
                        inputPlaceholder: 'Nhập số lượng',
                        inputAttributes: {
                            min: 1,
                            step: 1
                        },
                        showCancelButton: true,
                        confirmButtonText: 'Thêm',
                        cancelButtonText: 'Hủy',
                        inputValidator: (value) => {
                            if (!value || parseInt(value) <= 0 || isNaN(value)) {
                                return 'Vui lòng nhập số lượng hợp lệ!';
                            }
                        }
                    });

                    // Nếu người dùng nhập số lượng
                    if (quantity) {
                        try {
                            const response = await axios.get(`/admin/taiquay/add-sanpham-hdctqr/${productId}`, {
                                params: {
                                    quantity: parseInt(quantity),
                                    idHoaDon: idHoaDon
                                }
                            });

                            // Nếu thêm sản phẩm thành công, refresh lại danh sách
                            if (response.data && response.data.tongTien && response.data.listHDCT) {
                                // Gọi AJAX để lấy lại toàn bộ danh sách hóa đơn chi tiết
                                await refreshHoaDonChiTiet();

                                Swal.fire({
                                    icon: 'success',
                                    title: 'Thành Công',
                                    text: 'Sản phẩm đã được thêm vào giỏ hàng.',
                                    timer: 1000,
                                    showConfirmButton: false
                                });
                            }
                        } catch (error) {
                            // Xử lý lỗi từ server
                            if (error.response && error.response.data && error.response.data.errorSoLuong) {
                                // Hiển thị thông báo lỗi về số lượng sản phẩm
                                const result = await Swal.fire({
                                    icon: 'warning',
                                    title: 'Cảnh Báo',
                                    text: error.response.data.errorSoLuong,
                                    confirmButtonText: 'Đóng'
                                });

                                // Nếu người dùng bấm "Đóng", yêu cầu nhập lại số lượng
                                if (result.isConfirmed) {
                                    await requestQuantity();
                                }
                            } else {
                                // Xử lý các lỗi khác
                                console.error("Lỗi khi thêm sản phẩm vào giỏ hàng:", error);
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Lỗi',
                                    text: 'Có lỗi xảy ra, vui lòng thử lại.'
                                });
                            }
                        }
                    }
                };

                // Gọi hàm yêu cầu nhập số lượng
                await requestQuantity();
            }

            if (isCameraOn) {
                requestAnimationFrame(tick);
            }
        } else {
            console.log("Video not ready, waiting...");
            setTimeout(() => {
                requestAnimationFrame(tick);
            }, 200);
        }
    }
 // refresh giỏ hàng before add sp from qr
    async function refreshHoaDonChiTiet() {
        try {
            const response = await axios.get(`/admin/taiquay/detail/${idHoaDon}`);

            // Cập nhật bảng
            const cartTableBody = document.getElementById("cartTable1");
            const totalElement = document.querySelector(".total");

            if (cartTableBody && response.data.listHDCT) {
                // Xóa toàn bộ dòng hiện tại
                cartTableBody.innerHTML = '';

                // Thêm từng sản phẩm mới
                response.data.listHDCT.forEach((item, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.sanPhamChiTiet.sanPham.tenSanPham}</td>
                    <td>
                        <button class='btn btn-sm btn-light' onclick='updateQuantity(${item.id}, -1)'>-</button>
                        ${item.soLuong}
                        <button class='btn btn-sm btn-light' onclick='updateQuantity(${item.id}, 1)'>+</button>
                    </td>
                    <td>${formatCurrency(item.sanPhamChiTiet.gia)}đ</td>
                    <td>${formatCurrency(item.sanPhamChiTiet.gia * item.soLuong)}đ</td>
                    <td>
                        <a href='/admin/taiquay/xoa-sanpham-hdct/${item.id}' class='btn btn-light'>
                            <i class='bi bi-trash-fill fs-5'></i>
                        </a>
                    </td>
                `;
                    cartTableBody.appendChild(row);
                });
            }
            // Cập nhật tổng tiền
            if (totalElement && response.data.tongTien) {
                totalElement.textContent = formatCurrency(response.data.tongTien) + " vnđ";
            }
        } catch (error) {
            console.error("Lỗi khi refresh danh sách hóa đơn chi tiết:", error);
        }
    }

    // Hàm update giỏ hàng
    function updateCartDynamically(responseData) {
        // Kiểm tra và lấy phần tử an toàn
        const totalElement = document.querySelector(".total");
        const cartTableBody = document.getElementById("cartTable1");

        // Kiểm tra từng phần tử trước khi thao tác
        if (totalElement && responseData.tongTien) {
            totalElement.textContent = responseData.tongTien + " vnđ";
        }

        // Kiểm tra nếu có danh sách sản phẩm
        if (cartTableBody && responseData.listHDCT && responseData.listHDCT.length > 0) {
            // Xóa toàn bộ dòng hiện tại
            cartTableBody.innerHTML = '';

            // Thêm từng sản phẩm mới
            responseData.listHDCT.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                <td>${index + 1}</td>
                <td>${item.sanPhamChiTiet.sanPham.tenSanPham}</td>
                <td>
                    <button class='btn btn-sm btn-light' onclick='updateQuantity(${item.id}, -1)'>-</button>
                    ${item.soLuong}
                    <button class='btn btn-sm btn-light' onclick='updateQuantity(${item.id}, 1)'>+</button>
                </td>
                <td>${formatCurrency(item.sanPhamChiTiet.gia)}đ</td>
                <td>${formatCurrency(item.sanPhamChiTiet.gia * item.soLuong)}đ</td>
                <td>
                    <a href='/admin/taiquay/xoa-sanpham-hdct/${item.id}' class='btn btn-light'>
                        <i class='bi bi-trash-fill fs-5'></i>
                    </a>
                </td>
            `;
                cartTableBody.appendChild(row);
            });
        } else {
            console.error('Không tìm thấy phần tử cart table hoặc danh sách rỗng', {
                cartTableBody,
                listHDCT: responseData.listHDCT
            });
        }
    }

    // Hàm format tiền tệ
    function formatCurrency(amount) {
        return new Intl.NumberFormat('vi-VN').format(amount);
    }
</script>
<!--js confirm print pdf for hd-->
<script>
    document.getElementById("paymentForm").onsubmit = function (event) {
        event.preventDefault(); // Ngăn hành vi submit mặc định của form

        // Lấy dữ liệu form
        const form = document.getElementById("paymentForm");
        const formData = new FormData(form);

        // Thực hiện submit form qua fetch API
        fetch(form.action + "?" + new URLSearchParams(formData), {
            method: "GET"
        })
            .then(response => response.text()) // Lấy URL file PDF từ server
            .then(pdfUrl => {
                if (pdfUrl) {
                    // Hiển thị hộp thoại xác nhận in hóa đơn
                    Swal.fire({
                        title: 'In Hóa Đơn',
                        text: "Bạn có muốn in hóa đơn không?",
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Có, in hóa đơn',
                        cancelButtonText: 'Không, để sau'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            // Nếu người dùng chọn in
                            window.open(pdfUrl, "_blank");
                        }
                        // Luôn chuyển về trang admin/taiquay sau khi xử lý
                        window.location.href = "/admin/taiquay";
                    });
                } else {
                    // Nếu không có PDF
                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi',
                        text: 'Không thể tạo file PDF!'
                    }).then(() => {
                        window.location.href = "/admin/taiquay";
                    });
                }
            })
            .catch(error => {
                console.error("Lỗi khi xử lý thanh toán:", error);
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi',
                    text: 'Đã xảy ra lỗi trong quá trình thanh toán!'
                }).then(() => {
                    window.location.href = "/admin/taiquay";
                });
            });
    };
</script>

<!-- Thêm thư viện SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!--//-->
<script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<!--<script th:src="@{/javascript/locSanPhamTaiQuay.js}"></script>-->
<script>
    document.getElementById('toggleAddress').addEventListener('change', function () {
        const addressForm = document.getElementById('addressForm');
        if (this.checked) {
            addressForm.style.display = 'block';
        } else {
            addressForm.style.display = 'none';
        }
    });

</script>
<!--UPDATE SL SAN PHAM TRONG GH-->
<script>
    function updateQuantity(hdctId, delta) {
        const url = `/admin/taiquay/update-sanpham-hdct/${hdctId}?delta=${delta}`;

        fetch(url, {
            method: 'POST'
        })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    // Cập nhật lại giao diện bảng
                    document.getElementById('cartTable1').innerHTML = data.updatedCartHtml;
                    // Cập nhật tổng tiền
                    document.getElementById('tongTien').innerText = data.tongTien;
                }
            })
            .catch(error => console.error('Error:', error));
    }
</script>
</html>